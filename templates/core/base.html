<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Estate-Admin | Dashboard</title>

 {% include 'core/headers.html' %}
 {% block custom_css %}
 {# Additional page-specific CSS can be added here #}
 {% endblock custom_css %}
</head>
<body class="hold-transition sidebar-mini layout-fixed app-body">
<div class="wrapper">

  <!-- Preloader -->
  <div class="preloader flex-column justify-content-center align-items-center">
    {% if site_logo %}
      <img class="animation__shake" src="/media/{{site_logo}}" alt="AdminLTELogo" height="60" width="60">
    {% else %}
    <img class="animation__shake" src="{% static 'dist/img/logo.png' %}" alt="AdminLTELogo" height="60" width="60">
    {% endif %}
  </div>

  {% include 'core/includes/navbar.html' %}

  {% include 'core/includes/messages.html' %}

  {% include 'core/includes/sidebar.html' %}

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper app-content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header app-content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0 app-page-title">{% block page_title %}{{page_title|default:"Dashboard"}}{% endblock %}</h1>
          </div><!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right app-breadcrumb">
              <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
              <li class="breadcrumb-item active">{% block breadcrumb_active %}{{page_title|default:"Dashboard"}}{% endblock %}</li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
   {% block content %}
   {% endblock content %}
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  {% include 'core/includes/footer.html' %}

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->
{% include 'core/scripts.html' %}
{% block custom_js %}
<script>
  // Enhanced Search Bar Toggle
  document.addEventListener('DOMContentLoaded', function() {
    const body = document.body;
    const sidebarOverlay = document.createElement('div');

    sidebarOverlay.className = 'sidebar-overlay';
    document.body.appendChild(sidebarOverlay);

    // Initialize sidebar state based on viewport width
    if (window.innerWidth < 992) {
      body.classList.remove('sidebar-open');
      body.classList.add('sidebar-collapsed');
    } else {
      body.classList.add('sidebar-open');
      body.classList.remove('sidebar-collapsed');
    }

    // Close sidebar on Escape for small screens
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && window.innerWidth < 992) {
        body.classList.remove('sidebar-open');
        body.classList.add('sidebar-collapsed');
      }
    });

    // Sidebar collapse/tooltip behavior & keyboard accessibility
    (function() {
      let bsTooltips = [];

      function initTooltips() {
        // dispose old first
        bsTooltips.forEach(t => t.dispose && t.dispose());
        bsTooltips = [];
        // initialize for links with title
        document.querySelectorAll('.sidebar .nav-link[title]').forEach(el => {
          // attach tooltip but only show when collapsed
          // Prefer Bootstrap 5 API if available
          if (window.bootstrap && typeof window.bootstrap.Tooltip === 'function') {
            el.setAttribute('data-bs-toggle', 'tooltip');
            el.setAttribute('data-bs-placement', 'right');
            const tt = new bootstrap.Tooltip(el, { trigger: 'hover focus' });
            bsTooltips.push(tt);
          } else if (window.jQuery && typeof jQuery.fn.tooltip === 'function') {
            // Bootstrap 4 / jQuery tooltip fallback
            el.setAttribute('data-toggle', 'tooltip');
            el.setAttribute('data-placement', 'right');
            jQuery(el).tooltip({ trigger: 'hover focus', placement: 'right' });
            bsTooltips.push({ dispose: function(){ jQuery(el).tooltip('dispose'); } });
          } else {
            // no-js/css-only fallback will handle this
          }
        });
      }

      function destroyTooltips() {
        bsTooltips.forEach(t => t.dispose && t.dispose());
        bsTooltips = [];
        document.querySelectorAll('.sidebar .nav-link[title]').forEach(el => {
          el.removeAttribute('data-bs-toggle');
          el.removeAttribute('data-bs-placement');
          el.removeAttribute('data-toggle');
          el.removeAttribute('data-placement');
        });
      }

      function updateTooltipsOnState() {
        if (document.body.classList.contains('sidebar-collapsed')) {
          initTooltips();
        } else {
          destroyTooltips();
        }
      }

      // initial state
      updateTooltipsOnState();

      // handle toggle button
      const btn = document.getElementById('sidebarCollapseBtn');
      const toggleIcon = btn ? btn.querySelector('i') : null;
      if (btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          document.body.classList.toggle('sidebar-collapsed');
          document.body.classList.toggle('sidebar-open');
          const expanded = document.body.classList.contains('sidebar-open') && !document.body.classList.contains('sidebar-collapsed');
          btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          updateTooltipsOnState();
        });

        // keyboard support for Enter and Space
        btn.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            btn.click();
          }
        });
      }

      // Re-evaluate on resize
      window.addEventListener('resize', function() {
        // if switching between mobile/desktop, adjust state
        if (window.innerWidth < 992) {
          document.body.classList.remove('sidebar-open');
          document.body.classList.add('sidebar-collapsed');
        } else {
          document.body.classList.add('sidebar-open');
          document.body.classList.remove('sidebar-collapsed');
        }
        updateTooltipsOnState();
      });

    })();

    function openSidebar() {
      body.classList.add('sidebar-open');
      body.classList.remove('sidebar-collapsed');
    }

    function closeSidebar() {
      body.classList.remove('sidebar-open');
      body.classList.add('sidebar-collapsed');
    }

    sidebarOverlay.addEventListener('click', closeSidebar);

    document.querySelectorAll('[data-widget="pushmenu"]').forEach(function(toggle) {
      toggle.addEventListener('click', function(e) {
        e.preventDefault();
        if (body.classList.contains('sidebar-open')) {
          closeSidebar();
        } else {
          openSidebar();
        }
      });
    });

    const dropdownItems = Array.from(document.querySelectorAll('.nav-item.dropdown'));
    const bootstrapAvailable = (window.bootstrap && typeof window.bootstrap.Dropdown === 'function');
    const jqueryAvailable = (window.jQuery && window.jQuery.fn && typeof window.jQuery.fn.dropdown === 'function');

    if (bootstrapAvailable) {
      dropdownItems.forEach(function(item) {
        const toggle = item.querySelector('.dropdown-toggle');
        if (toggle) {
          new window.bootstrap.Dropdown(toggle, { autoClose: true });
        }
      });
    } else if (jqueryAvailable) {
      dropdownItems.forEach(function(item) {
        const toggle = item.querySelector('.dropdown-toggle');
        if (toggle) {
          window.jQuery(toggle).dropdown();
        }
      });
    } else {
      // Fallback simple dropdown behaviour
      function closeAllDropdowns() {
        dropdownItems.forEach(function(item) {
          item.classList.remove('show');
          const menu = item.querySelector('.dropdown-menu');
          const toggle = item.querySelector('.dropdown-toggle');
          if (menu) {
            menu.classList.remove('show');
          }
          if (toggle) {
            toggle.setAttribute('aria-expanded', 'false');
          }
        });
      }

      dropdownItems.forEach(function(item) {
        const toggle = item.querySelector('.dropdown-toggle');
        const menu = item.querySelector('.dropdown-menu');
        if (!toggle || !menu) {
          return;
        }

        toggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const isOpen = item.classList.contains('show');
          closeAllDropdowns();
          if (!isOpen) {
            item.classList.add('show');
            menu.classList.add('show');
            toggle.setAttribute('aria-expanded', 'true');
          }
        });

        menu.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      });

      document.addEventListener('click', function() {
        closeAllDropdowns();
      });
    }

    const searchToggle = document.querySelector('[data-widget="navbar-search"]');
    const searchBlock = document.querySelector('.navbar-search-block');
    const searchClose = searchBlock ? searchBlock.querySelector('[data-widget="navbar-search"]') : null;
    
    if (searchToggle && searchBlock) {
      searchToggle.addEventListener('click', function(e) {
        e.preventDefault();
        searchBlock.classList.toggle('show');
        if (searchBlock.classList.contains('show')) {
          setTimeout(function() {
            searchBlock.querySelector('.form-control-navbar').focus();
          }, 100);
        }
      });
      
      if (searchClose) {
        searchClose.addEventListener('click', function(e) {
          e.preventDefault();
          searchBlock.classList.remove('show');
        });
      }
      
      // Close search when clicking outside
      document.addEventListener('click', function(e) {
        if (searchBlock && !searchBlock.contains(e.target) && !searchToggle.contains(e.target)) {
          searchBlock.classList.remove('show');
        }
      });
    }
  });
</script>
{% endblock custom_js %}

</body>
</html>