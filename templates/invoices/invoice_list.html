{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="modern-table-container">
  <div class="modern-table-header">
    <h2><i class="fas fa-file-invoice-dollar mr-2"></i>Invoice List</h2>
    <div class="modern-table-actions">
      {% if request.user.user_type == '1' or request.user.user_type == '2' %}
      <a href="{% url 'invoice-create' %}" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
        <i class="fas fa-plus mr-1"></i>Generate New
      </a>
      {% endif %}
      {% if request.user.user_type == '4' %}
        {% if show_overdue %}
          <a href="{% url 'invoice-list' %}" class="btn btn-outline-secondary btn-sm">Show All Invoices</a>
        {% else %}
          <a href="{% url 'invoice-list' %}?overdue=1" class="btn btn-outline-warning btn-sm">
            <i class="fas fa-exclamation-triangle mr-1"></i>Show Overdue Only
          </a>
        {% endif %}
      {% endif %}
      {% if is_facility_manager %}
        {% if show_maintenance %}
          <a href="{% url 'invoice-list' %}" class="btn btn-outline-secondary btn-sm">Show All Invoices</a>
        {% else %}
          <a href="{% url 'invoice-list' %}?maintenance=1" class="btn btn-outline-info btn-sm">
            <i class="fas fa-wrench mr-1"></i>Show Maintenance Only
          </a>
        {% endif %}
      {% endif %}
    </div>
  </div>

  {% if invoices %}
  <table id="invoiceTable" class="modern-table">
    <thead>
      <tr>
        <th>Lease</th>
        <th>Invoice Type</th>
        <th>Overdue?</th>
        <th>Invoiced Amount</th>
        <th>Invoice Balance</th>
        <th>Due Date</th>
        <th>Payment Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for invoice in invoices %}
      <tr>
        <td><strong>{{ invoice.lease }}</strong></td>
        <td>
          <span class="text-capitalize">{{ invoice.invoice_type }}</span>
          {% if invoice.invoice_type == 'maintenance' %}
            <span class="badge badge-info ml-1">Maintenance</span>
          {% endif %}
        </td>
        <td>
          {% if invoice.due_date and invoice.due_date < today and invoice.status != 'Paid' %}
            <span class="badge-modern badge-overdue">OVERDUE</span>
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}
        </td>
        <td><strong>KES {{ invoice.amount|floatformat:2|intcomma }}</strong></td>
        <td><strong>KES {{ invoice.balance|floatformat:2|intcomma }}</strong></td>
        <td>{{ invoice.due_date|date:"M d, Y" }}</td>
        <td>
          {% if invoice.status == 'Paid' %}
            <span class="badge-modern badge-paid">{{ invoice.status }}</span>
          {% elif invoice.status == 'Partial' %}
            <span class="badge-modern badge-partial">{{ invoice.status }}</span>
          {% else %}
            <span class="badge-modern badge-pending">{{ invoice.status }}</span>
          {% endif %}
        </td>
        <td>
          <div class="action-buttons">
            <a href="{% url 'invoice-detail' invoice.pk %}" class="btn-action btn-action-view" title="View Invoice">
              <i class="fas fa-eye"></i>
              <span class="d-none d-md-inline">View</span>
            </a>
            {% if request.user.user_type == '1' or request.user.user_type == '2' %}
              {% if invoice.status != 'Paid' %}
                <a href="{% url 'payment_create' %}?invoice_id={{ invoice.id }}" class="btn-action btn-action-cash" title="Record Cash Payment">
                  <i class="fas fa-money-bill-wave"></i>
                  <span class="d-none d-lg-inline">Cash</span>
                </a>
                <a href="{% url 'lipa_na_mpesa' %}?invoice_id={{ invoice.id }}&amount={{ invoice.balance }}&description=Mpesa%20payment%20for%20invoice%20{{ invoice.invoice_id }}" class="btn-action btn-action-mpesa" title="Mpesa STK Push">
                  <i class="fas fa-mobile-alt"></i>
                  <span class="d-none d-lg-inline">Mpesa</span>
                </a>
              {% endif %}
              <a href="{% url 'invoice-update' invoice.pk %}" class="btn-action btn-action-edit" title="Edit Invoice">
                <i class="fas fa-edit"></i>
                <span class="d-none d-md-inline">Edit</span>
              </a>
              <a href="{% url 'invoice-delete' invoice.pk %}" class="btn-action btn-action-delete" title="Delete Invoice" onclick="return confirm('Are you sure you want to delete this invoice?');">
                <i class="fas fa-trash"></i>
                <span class="d-none d-md-inline">Delete</span>
              </a>
            {% endif %}
            {% if request.user.user_type == '4' and invoice.status != 'Paid' %}
              <a href="{% url 'lipa_na_mpesa' %}?invoice_id={{ invoice.id }}&amount={{ invoice.balance }}&description=Online%20Mpesa%20payment" class="btn-action btn-action-mpesa" title="Pay via Mpesa">
                <i class="fas fa-mobile-alt"></i>
                <span class="d-none d-md-inline">Pay via Mpesa</span>
              </a>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="table-empty-state">
    <i class="fas fa-inbox"></i>
    <h3>No Invoices Found</h3>
    <p>There are no invoices to display at this time.</p>
  </div>
  {% endif %}
</div>

<script>
  $(document).ready(function() {
    $('#invoiceTable').DataTable({
      paging: true,
      searching: true,
      order: [[5, 'asc']],
      pageLength: 10,
      lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
      language: {
        search: "",
        searchPlaceholder: "Search invoices...",
        lengthMenu: "Show _MENU_ entries",
        info: "Showing _START_ to _END_ of _TOTAL_ entries",
        paginate: {
          previous: "<i class='fas fa-chevron-left'></i>",
          next: "<i class='fas fa-chevron-right'></i>"
        }
      },
      columnDefs: [
        { type: 'date', targets: 5 },
        { orderable: false, targets: [2, 7] } // Disable sorting on Overdue and Actions columns
      ],
      responsive: true
    });
  });
</script>
{% endblock %}
